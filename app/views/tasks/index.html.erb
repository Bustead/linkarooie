<%= link_to 'New Task', new_task_path %>

<div class="container">
  <div class="row">
    <% ['To-do', 'In-progress', 'Completed'].each do |status| %>
      <div class="col-4">
        <h3><%= status %></h3>
        <div class="task-list" id="<%= status.parameterize %>" ondrop="drop(event, '<%= status %>')" ondragover="allowDrop(event)">
          <% @tasks.select { |task| task.status == status }.sort_by(&:priority).each do |task| %>
            <div class="card" id="<%= task.id %>" draggable="true" ondragstart="drag(event)">
              <div class="card-body">
                <p><%= task.description %></p>
                <p><strong>Priority: </strong><%= task.priority %></p>
                <p><strong>Category: </strong><%= task.category %></p>
                <%= link_to 'Edit', edit_task_path(task) %> |
                <%= link_to 'Delete', task, method: :delete, data: { confirm: 'Are you sure?' } %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  function allowDrop(ev) {
    ev.preventDefault();
  }

  function drag(ev) {
    ev.dataTransfer.setData("text", ev.target.id);
  }

  function drop(ev, status) {
    ev.preventDefault();
    var data = ev.dataTransfer.getData("text");
    ev.target.appendChild(document.getElementById(data));

    fetch(`/tasks/${data}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': getMeta("csrf-token")
      },
      body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
      console.log(data);
    });
  }

  function getMeta(metaName) {
    const metas = document.getElementsByTagName('meta');
    for (let i = 0; i < metas.length; i++) {
      if (metas[i].getAttribute('name') === metaName) {
        return metas[i].getAttribute('content');
      }
    }
    return '';
  }
});
</script>
